---
title: "Confirmatory Factor Analysis with a Small Sample"
author: "Juan C. Correa"
date: "2024-01-06"
output: html_document
---


CFA is a well-known technique in psychology and social sciences. Despite its reputation, like any other technique, it also has its limitations. For example, in educational research, it is quite common to have small sample size (few observations) if they are collected through survey-based techniques such as scales or questionnaires. Our following case builds upon the context of a COIL experience where 65 students (i.e., 33 from Colombia and 32 from Ecuador) got together during six weeks for a two-hour-sessions per week using Google Classroom. Let's open the data an conduct a standard Confirmatory Factor Analysis. 

```{r}
library(readr)
coil <- read_delim("coil.csv", delim = ";", 
    escape_double = FALSE, trim_ws = TRUE)
```


## Confirmatory Factor Analysis




```{r}
#
# This model specification was automatically generated by Onyx
#
library(lavaan);
modelData <- coil
 model<-"
! regressions 
   DS=~x2__Instrumental*IN
   DS=~x2__Stra_Privilege*PR
   DS=~x2__Stra_Appropriation*AP
   DS=~x2__Expansive*EX
! residuals, variances and covariances
   IN ~~ VAR_Instrumental*IN
   PR ~~ VAR_Stra_Privilege*PR
   AP ~~ VAR_Stra_Appropriation*AP
   EX ~~ VAR_Expansive*EX
   DS ~~ 1.0*DS
! observed means
   IN~1;
   PR~1;
   AP~1;
   EX~1;
";
result1<-lavaan(model, data=modelData, fixed.x=FALSE, estimator="ML", std.ov=TRUE);
result2<-lavaan(model, data=modelData, fixed.x=FALSE, estimator="MLM", std.ov = TRUE);
result2
```



A graphical output of "result2" should look like this:

```{r}
library(semPlot)
semPaths(result2, whatLabels = "std", layout = "tree", color = list(
  lat = rgb(124, 12, 199, maxColorValue = 255),
  man = rgb(155, 253, 175, maxColorValue = 255)),
  edge.color = "black",
  edge.label.cex = 1,
  edge.width = 1.5,
  label.cex = 2,
  node.width = 2,
  node.height = 2,
  mar = c(10, 5, 10, 5), intercepts = FALSE, residuls = FALSE, nCharNodes = 0)
```



To inspect the standardized estimates for factor loadings
```{r}
lavInspect(result2, what = "std.all")
```

The bad news is that the goodness-of-fit reported are misleading because they are the result of an improper solution that is visible when we inspect the estimated variance-covariance matrix for all observed and latent variables.

```{r, echo = TRUE}
m1 <- lavInspect(result2, what = "vcov.std.all")
eigen(m1)
```

The definitive proof that this solution is not admissible is evident if you run the Cholesky decomposition by running `chol(m1)`

